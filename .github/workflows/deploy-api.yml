name: Deploy API
on:
  push:
    branches:
      - main
      - cloud
    paths: 
      - 'api/**'
      - '.github/workflows/deploy-api.yml'
  workflow_dispatch:
      
jobs:
  DeployAPI:
    timeout-minutes: 15
    runs-on: ubuntu-latest
    steps:
      - name: checkout code repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: setup node.js
        uses: actions/setup-node@v2
        with:
          node-version: 20
      - name: install yarn
        run: npm install -g yarn
      - name: Configure AWS credentials
        run: aws configure set aws_access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }} && aws configure set aws_secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }} && aws configure set default.region ${{ secrets.AWS_DEFAULT_REGION }}
      - name: install dependencies
        run: yarn
      - name: Prepare and Deploy API
        run: |
          cd api
          printenv | grep "^API_" | while IFS= read -r line; do
            echo "${line#API_}" >> .env
          done
          yarn prepare:all
          yarn deploy:aws